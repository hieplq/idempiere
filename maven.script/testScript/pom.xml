<!-- run test by mvn gplus:execute -->
<project xmlns="http://maven.apache.org/POM/4.0.0" xmlns:xsi="http://www.w3.org/2001/XMLSchema-instance" xsi:schemaLocation="http://maven.apache.org/POM/4.0.0 http://maven.apache.org/xsd/maven-4.0.0.xsd">
  <modelVersion>4.0.0</modelVersion>
  <groupId>org.idempiere</groupId>
  <artifactId>test.groovy</artifactId>
  <version>7.1.0-SNAPSHOT</version>
  <packaging>pom</packaging>
  <properties>
    <tycho.version>2.1.0</tycho.version>
    <tycho.extras.version>${tycho.version}</tycho.extras.version>
    <idempiere-equinox-url>https://download.eclipse.org/eclipse/updates/4.17</idempiere-equinox-url>
    <idempiere-equinox-repository-id>eclipse-2020-09</idempiere-equinox-repository-id>
    <idempiere-orbit-url>https://download.eclipse.org/tools/orbit/downloads/drops/R20200831200620/repository</idempiere-orbit-url>
    <idempiere-orbit-repository-id>orbit-2020-09-R20200831200620</idempiere-orbit-repository-id>
  </properties>
  <build>
    <pluginManagement>
      <plugins>
        <plugin>
          <groupId>org.codehaus.gmavenplus</groupId>
          <artifactId>gmavenplus-plugin</artifactId>
          <version>1.11.0</version>
          <dependencies>
            <dependency>
              <groupId>org.codehaus.groovy</groupId>
              <artifactId>groovy-all</artifactId>
              <version>3.0.6</version>
              <type>pom</type>
              <scope>runtime</scope>
            </dependency>
          </dependencies>
        </plugin>
        <plugin>
          <groupId>org.eclipse.tycho.extras</groupId>
          <artifactId>tycho-eclipserun-plugin</artifactId>
          <version>${tycho.extras.version}</version>
          <configuration>
            <repositories>
              <repository>
                <id>${idempiere-equinox-repository-id}</id>
                <url>${idempiere-equinox-url}</url>
                <layout>p2</layout>
              </repository>
              <repository>
                <id>${idempiere-orbit-repository-id}</id>
                <url>${idempiere-orbit-url}</url>
                <layout>p2</layout>
              </repository>
            </repositories>
          </configuration>
        </plugin>
      </plugins>
    </pluginManagement>
    <plugins>
      <plugin>
        <groupId>org.eclipse.tycho.extras</groupId>
        <artifactId>tycho-eclipserun-plugin</artifactId>
        <executions>
          <execution>
            <id>create idempiere product</id>
            <goals>
              <goal>eclipse-run</goal>
            </goals>
            <phase>package-skiptest</phase>
            <configuration>
              <appArgLine>-application org.eclipse.equinox.p2.director -repository file:/mnt/data/1Dev/triage/dev/idempiere/maven.script/testScript/localRepository -destination ${project.build.directory}/products/${tycho.env.osgi.os}/${tycho.env.osgi.ws}/${tycho.env.osgi.arch} -installIU "org.eclipse.equinox.p2.director, org.idempiere.equinox.p2.director.feature.feature.group, org.idempiere.test.feature.feature.group" -profileProperties org.eclipse.update.install.features=true -p2.os ${tycho.env.osgi.os} -p2.ws ${tycho.env.osgi.ws} -p2.arch ${tycho.env.osgi.arch} -consoleLog -roaming</appArgLine>
              <dependencies>
                <dependency>
                  <artifactId>org.eclipse.equinox.p2.sdk</artifactId>
                  <type>eclipse-feature</type>
                </dependency>
                <dependency>
                  <artifactId>org.eclipse.ecf</artifactId>
                  <type>eclipse-plugin</type>
                </dependency>
                <dependency>
                  <artifactId>org.eclipse.equinox.ds</artifactId>
                  <type>eclipse-plugin</type>
                </dependency>
                <dependency>
                  <artifactId>org.eclipse.ecf</artifactId>
                  <type>eclipse-plugin</type>
                </dependency>
                <dependency>
                  <artifactId>org.eclipse.equinox.ds</artifactId>
                  <type>eclipse-plugin</type>
                </dependency>
                <dependency>
                  <artifactId>org.eclipse.equinox.p2.garbagecollector</artifactId>
                  <type>eclipse-plugin</type>
                </dependency>
                <dependency>
                  <artifactId>org.eclipse.equinox.frameworkadmin.equinox</artifactId>
                  <type>eclipse-plugin</type>
                </dependency>
                <dependency>
                  <artifactId>org.eclipse.equinox.p2.publisher.eclipse</artifactId>
                  <type>eclipse-plugin</type>
                </dependency>
                <dependency>
                  <artifactId>org.apache.commons.logging</artifactId>
                  <type>eclipse-plugin</type>
                </dependency>
                <dependency>
                  <artifactId>org.eclipse.ecf.provider.filetransfer.httpclient45</artifactId>
                  <type>eclipse-plugin</type>
                </dependency>
                <dependency>
                  <artifactId>org.eclipse.equinox.p2.director</artifactId>
                  <type>eclipse-plugin</type>
                </dependency>
                <dependency>
                  <artifactId>org.eclipse.equinox.common</artifactId>
                  <type>eclipse-plugin</type>
                </dependency>
                <dependency>
                  <artifactId>org.eclipse.equinox.p2.metadata</artifactId>
                  <type>eclipse-plugin</type>
                </dependency>
                <dependency>
                  <artifactId>org.tukaani.xz</artifactId>
                  <type>eclipse-plugin</type>
                </dependency>
                <dependency>
                  <artifactId>org.eclipse.equinox.p2.core</artifactId>
                  <type>eclipse-plugin</type>
                </dependency>
                <dependency>
                  <artifactId>org.eclipse.core.net</artifactId>
                  <type>eclipse-plugin</type>
                </dependency>
                <dependency>
                  <artifactId>org.eclipse.equinox.concurrent</artifactId>
                  <type>eclipse-plugin</type>
                </dependency>
                <dependency>
                  <artifactId>org.eclipse.core.contenttype</artifactId>
                  <type>eclipse-plugin</type>
                </dependency>
                <dependency>
                  <artifactId>org.eclipse.equinox.p2.updatesite</artifactId>
                  <type>eclipse-plugin</type>
                </dependency>
                <dependency>
                  <artifactId>org.apache.httpcomponents.httpcore</artifactId>
                  <type>eclipse-plugin</type>
                </dependency>
                <dependency>
                  <artifactId>org.eclipse.equinox.p2.touchpoint.eclipse</artifactId>
                  <type>eclipse-plugin</type>
                </dependency>
                <dependency>
                  <artifactId>org.eclipse.core.jobs</artifactId>
                  <type>eclipse-plugin</type>
                </dependency>
                <dependency>
                  <artifactId>org.eclipse.equinox.preferences</artifactId>
                  <type>eclipse-plugin</type>
                </dependency>
                <dependency>
                  <artifactId>org.eclipse.equinox.registry</artifactId>
                  <type>eclipse-plugin</type>
                </dependency>
                <dependency>
                  <artifactId>org.eclipse.equinox.simpleconfigurator.manipulator</artifactId>
                  <type>eclipse-plugin</type>
                </dependency>
                <dependency>
                  <artifactId>org.eclipse.equinox.security</artifactId>
                  <type>eclipse-plugin</type>
                </dependency>
                <dependency>
                  <artifactId>org.eclipse.equinox.p2.jarprocessor</artifactId>
                  <type>eclipse-plugin</type>
                </dependency>
                <dependency>
                  <artifactId>org.eclipse.equinox.p2.engine</artifactId>
                  <type>eclipse-plugin</type>
                </dependency>
                <dependency>
                  <artifactId>org.eclipse.ecf.identity</artifactId>
                  <type>eclipse-plugin</type>
                </dependency>
                <dependency>
                  <artifactId>org.eclipse.equinox.app</artifactId>
                  <type>eclipse-plugin</type>
                </dependency>
                <dependency>
                  <artifactId>org.apache.felix.scr</artifactId>
                  <type>eclipse-plugin</type>
                </dependency>
                <dependency>
                  <artifactId>org.eclipse.equinox.p2.repository</artifactId>
                  <type>eclipse-plugin</type>
                </dependency>
                <dependency>
                  <artifactId>org.apache.httpcomponents.httpclient</artifactId>
                  <type>eclipse-plugin</type>
                </dependency>
                <dependency>
                  <artifactId>org.eclipse.equinox.p2.artifact.repository</artifactId>
                  <type>eclipse-plugin</type>
                </dependency>
                <dependency>
                  <artifactId>org.eclipse.osgi.compatibility.state</artifactId>
                  <type>eclipse-plugin</type>
                </dependency>
                <dependency>
                  <artifactId>org.eclipse.ecf.provider.filetransfer</artifactId>
                  <type>eclipse-plugin</type>
                </dependency>
                <dependency>
                  <artifactId>org.eclipse.equinox.launcher</artifactId>
                  <type>eclipse-plugin</type>
                </dependency>
                <dependency>
                  <artifactId>org.eclipse.osgi.util</artifactId>
                  <type>eclipse-plugin</type>
                </dependency>
                <dependency>
                  <artifactId>org.eclipse.equinox.frameworkadmin</artifactId>
                  <type>eclipse-plugin</type>
                </dependency>
                <dependency>
                  <artifactId>org.eclipse.equinox.p2.repository.tools</artifactId>
                  <type>eclipse-plugin</type>
                </dependency>
                <dependency>
                  <artifactId>org.eclipse.equinox.p2.publisher</artifactId>
                  <type>eclipse-plugin</type>
                </dependency>
                <dependency>
                  <artifactId>org.eclipse.equinox.p2.touchpoint.natives</artifactId>
                  <type>eclipse-plugin</type>
                </dependency>
                <dependency>
                  <artifactId>org.apache.commons.codec</artifactId>
                  <type>eclipse-plugin</type>
                </dependency>
                <dependency>
                  <artifactId>org.eclipse.osgi.services</artifactId>
                  <type>eclipse-plugin</type>
                </dependency>
                <dependency>
                  <artifactId>org.eclipse.ecf.filetransfer</artifactId>
                  <type>eclipse-plugin</type>
                </dependency>
                <dependency>
                  <artifactId>org.eclipse.ecf.provider.filetransfer.ssl</artifactId>
                  <type>eclipse-plugin</type>
                </dependency>
                <dependency>
                  <artifactId>org.eclipse.ecf.ssl</artifactId>
                  <type>eclipse-plugin</type>
                </dependency>
                <dependency>
                  <artifactId>org.sat4j.core</artifactId>
                  <type>eclipse-plugin</type>
                </dependency>
                <dependency>
                  <artifactId>org.eclipse.core.runtime</artifactId>
                  <type>eclipse-plugin</type>
                </dependency>
                <dependency>
                  <artifactId>org.eclipse.equinox.p2.transport.ecf</artifactId>
                  <type>eclipse-plugin</type>
                </dependency>
                <dependency>
                  <artifactId>org.eclipse.equinox.p2.director.app</artifactId>
                  <type>eclipse-plugin</type>
                </dependency>
                <dependency>
                  <artifactId>org.sat4j.pb</artifactId>
                  <type>eclipse-plugin</type>
                </dependency>
                <dependency>
                  <artifactId>org.eclipse.equinox.p2.metadata.repository</artifactId>
                  <type>eclipse-plugin</type>
                </dependency>
                <dependency>
                  <artifactId>org.eclipse.equinox.simpleconfigurator</artifactId>
                  <type>eclipse-plugin</type>
                </dependency>
                <dependency>
                  <artifactId>org.eclipse.equinox.console</artifactId>
                  <type>eclipse-plugin</type>
                </dependency>
                <dependency>
                  <artifactId>org.apache.felix.gogo.command</artifactId>
                  <type>eclipse-plugin</type>
                </dependency>
                <dependency>
                  <artifactId>org.apache.felix.gogo.runtime</artifactId>
                  <type>eclipse-plugin</type>
                </dependency>
                <dependency>
                  <artifactId>org.apache.felix.gogo.shell</artifactId>
                  <type>eclipse-plugin</type>
                </dependency>
              </dependencies>
            </configuration>
          </execution>
          <execution>
            <id>generate local target platform</id>
            <goals>
              <goal>eclipse-run</goal>
            </goals>
            <phase>pre-integration-test-skip</phase>
            <configuration>
              <appArgLine>-consoleLog -application org.eclipse.cbi.targetplatform.tpd.converter ${targetDevPath}</appArgLine>
              <repositories>
                <repository>
                  <id>cbi-targetplatform-dsl</id>
                  <url>https://download.eclipse.org/cbi/tpd/3.0.0-SNAPSHOT</url>
                  <layout>p2</layout>
                </repository>
                <repository>
                  <id>eclipse-release-4.17</id><!--for xtext-->
                  <url>https://download.eclipse.org/releases/2020-09/202009161000/</url>
                  <layout>p2</layout>
                </repository>
              </repositories>
              <dependencies>
                <dependency>
                  <artifactId>org.eclipse.cbi.targetplatform-feature</artifactId>
                  <type>eclipse-feature</type>
                </dependency>
                <dependency>
                  <artifactId>org.eclipse.equinox.app</artifactId>
                  <type>eclipse-plugin</type>
                </dependency>
                <dependency>
                  <artifactId>org.eclipse.equinox.common</artifactId>
                  <type>eclipse-plugin</type>
                </dependency>
                <dependency>
                  <artifactId>org.eclipse.equinox.concurrent</artifactId>
                  <type>eclipse-plugin</type>
                </dependency>
                <dependency>
                  <artifactId>org.eclipse.equinox.console</artifactId>
                  <type>eclipse-plugin</type>
                </dependency>
                <dependency>
                  <artifactId>org.eclipse.equinox.ds</artifactId>
                  <type>eclipse-plugin</type>
                </dependency>
                <dependency>
                  <artifactId>org.eclipse.equinox.frameworkadmin</artifactId>
                  <type>eclipse-plugin</type>
                </dependency>
                <dependency>
                  <artifactId>org.eclipse.equinox.frameworkadmin.equinox</artifactId>
                  <type>eclipse-plugin</type>
                </dependency>
                <dependency>
                  <artifactId>org.eclipse.equinox.launcher</artifactId>
                  <type>eclipse-plugin</type>
                </dependency>
                <dependency>
                  <artifactId>org.eclipse.equinox.preferences</artifactId>
                  <type>eclipse-plugin</type>
                </dependency>
                <dependency>
                  <artifactId>org.eclipse.equinox.registry</artifactId>
                  <type>eclipse-plugin</type>
                </dependency>
                <dependency>
                  <artifactId>org.tukaani.xz</artifactId>
                  <type>eclipse-plugin</type>
                </dependency>
                <dependency>
                  <artifactId>org.eclipse.equinox.security</artifactId>
                  <type>eclipse-plugin</type>
                </dependency>
                <dependency>
                  <artifactId>org.eclipse.equinox.simpleconfigurator</artifactId>
                  <type>eclipse-plugin</type>
                </dependency>
                <dependency>
                  <artifactId>org.eclipse.equinox.simpleconfigurator.manipulator</artifactId>
                  <type>eclipse-plugin</type>
                </dependency>
                <dependency>
                  <artifactId>org.eclipse.osgi.services</artifactId>
                  <type>eclipse-plugin</type>
                </dependency>
                <dependency>
                  <artifactId>org.eclipse.osgi.util</artifactId>
                  <type>eclipse-plugin</type>
                </dependency>
                <dependency>
                  <artifactId>org.sat4j.core</artifactId>
                  <type>eclipse-plugin</type>
                </dependency>
                <dependency>
                  <artifactId>org.sat4j.pb</artifactId>
                  <type>eclipse-plugin</type>
                </dependency>
                <dependency>
                  <artifactId>org.eclipse.osgi</artifactId>
                  <type>eclipse-plugin</type>
                </dependency>
                <dependency>
                  <artifactId>org.eclipse.equinox.common</artifactId>
                  <type>eclipse-plugin</type>
                </dependency>
                <dependency>
                  <artifactId>org.eclipse.core.runtime</artifactId>
                  <type>eclipse-plugin</type>
                </dependency>
                <dependency>
                  <artifactId>org.eclipse.osgi.compatibility.state</artifactId>
                  <type>eclipse-plugin</type>
                </dependency>
                <dependency>
                  <artifactId>org.eclipse.ant.core</artifactId>
                  <type>eclipse-plugin</type>
                </dependency>
                <dependency>
                  <artifactId>org.eclipse.core.contenttype</artifactId>
                  <type>eclipse-plugin</type>
                </dependency>
                <dependency>
                  <artifactId>org.eclipse.core.variables</artifactId>
                  <type>eclipse-plugin</type>
                </dependency>
                <dependency>
                  <artifactId>org.eclipse.equinox.event</artifactId>
                  <type>eclipse-plugin</type>
                </dependency>
                <dependency>
                  <artifactId>org.eclipse.core.net</artifactId>
                  <type>eclipse-plugin</type>
                </dependency>
              </dependencies>
            </configuration>
          </execution>
        </executions>
      </plugin>
      <plugin>
        <groupId>org.codehaus.gmavenplus</groupId>
        <artifactId>gmavenplus-plugin</artifactId>
        <executions>
          <execution>
            <id>prepare test enviroment</id>
            <goals>
              <goal>execute</goal>
            </goals>
            <phase>validate</phase>
            <configuration>
              <scripts>
                <script><![CDATA[
                  if (session.userProperties['scriptDir'] == null && project.properties['scriptDir'] == null){
                    println 'set scriptDir = :' + session.getExecutionRootDirectory() + "/maven.script"
                    project.properties.setProperty('scriptDir', session.getExecutionRootDirectory() + "/maven.script")
                  }else{
                    println 'targetScriptDir set by product propertise or command line already:' + project.properties['targetScriptDir'] + "  " + session.userProperties['targetScriptDir']
                  }]]></script>
                <script><![CDATA[
                  def idempiereRoot=session.getExecutionRootDirectory() + "/../.."
                  
                  ant.sequential{
                    copy(file: idempiereRoot + "/org.idempiere.p2.targetplatform/org.idempiere.p2.targetplatformlocal.template.tpd", 
                      tofile:session.getExecutionRootDirectory() + "/org.idempiere.p2.targetplatform/org.idempiere.p2.targetplatformlocal.template.tpd",
                      overwrite:"true", encoding:"UTF-8", outputencoding:"UTF-8")

                    copy(file: idempiereRoot + "/maven.script/adjust.local.target.groovy", tofile:session.getExecutionRootDirectory() + "/maven.script/adjust.local.target.groovy", overwrite:"true", encoding:"UTF-8", outputencoding:"UTF-8")

                    copy(file: idempiereRoot + "/maven.script/auto.choose.target.groovy", tofile:session.getExecutionRootDirectory() + "/maven.script/auto.choose.target.groovy", overwrite:"true", encoding:"UTF-8", outputencoding:"UTF-8")

                    copy(file: idempiereRoot + "/maven.script/build.local.target.groovy", tofile:session.getExecutionRootDirectory() + "/maven.script/build.local.target.groovy", overwrite:"true", encoding:"UTF-8", outputencoding:"UTF-8")
                    
                    delete(dir: session.getExecutionRootDirectory() + "/target/repository")

                    copy(todir: session.getExecutionRootDirectory() + "/target/repository", overwrite:"true") {
                        fileset(dir: idempiereRoot + "/org.idempiere.p2/target/repository")
                    }
                  }]]></script>
              </scripts>
            </configuration>
          </execution>
          <execution>
            <id>prepare target and repository</id>
            <goals>
              <goal>execute</goal>
            </goals>
            <phase>package</phase>
            <configuration>
              <scripts>
                <script>${targetScriptDir}/build.local.target.groovy</script>
              </scripts>
            </configuration>
          </execution>
          <execution>
            <id>adjust tpd</id>
            <goals>
              <goal>execute</goal>
            </goals>
            <phase>verify</phase>
            <configuration>
              <scripts>
                <script>${targetScriptDir}/adjust.local.target.groovy</script>
              </scripts>
            </configuration>
          </execution>
        </executions>
      </plugin>
    </plugins>
  </build>
</project>

